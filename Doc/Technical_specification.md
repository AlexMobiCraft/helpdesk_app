# Техническое задание: Веб-приложение для службы технической поддержки (Обновлено)

## 1. Введение
Разработать веб-приложение с поддержкой PWA для службы технической поддержки. Система должна позволять пользователям оставлять заявки на ремонт/сервис, а техникам – обрабатывать их.

## 2. Основные роли пользователей
- **Пользователь (user)** – создаёт заявки, может прикреплять файлы, отслеживать статус, указывает приоритет заявки при создании.
- **Техник (technician)** – берёт заявки в работу, меняет статус, оставляет примечания, закрывает заявки. Может редактировать закрытые заявки, а также изменять приоритет заявки.
- **Администратор (admin)** – управляет пользователями, техникой, редактирует любые данные, выгружает отчёты, изменяет приоритет заявки, управляет справочниками приоритетов и статусов.

**Структура таблицы "Роли пользователей (user_roles)":**
| Поле        | Тип данных | Атрибуты                     | Описание                                      |
| :---------- | :--------- | :--------------------------- | :-------------------------------------------- |
| role_id     | integer    | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор роли                 |
| role_name   | varchar    | NOT NULL, UNIQUE             | Название роли (например, 'admin', 'technician') |
| description | text       |                              | Описание роли (необязательно)                 |

## 3. Функциональные требования

### 3.1. Авторизация и аутентификация
- Вход через логин/пароль.
- Система JWT-токенов.

### 3.2. Управление заявками
- Пользователь создаёт заявку с обязательными полями:
    - **ID устройства** (выбирается из списка).
    - **Имя пользователя** (автоматически).
    - **Описание проблемы** (текст).
    - **Дата и время создания** (автоматически).
    - **Приоритет заявки** (выбирается из справочника "Приоритеты").
- Необязательные поля:
    - **Фото** (до 5 штук).
    - **Видео**.
    - **Файл**.
    ( контроль типов/количества выполняется на фронтенде)
- Техник может взять заявку в работу → меняется статус ("Новая" → "Ожидает решения").
- Возможность прикрепления нескольких техников к одной заявке (реализовано через связующую таблицу "назначения\_техников").
- Редактирование заявки после закрытия (для техников).
- Изменение статуса заявки техником ("Ожидает решения" → "В работе" → "Закрыта"). Любая смена статуса через API допустима, логику контролирует фронтенд.
- Администратор и техник могут изменять приоритет заявки.
- Статусы заявок берутся из справочника "Статусы": "Новая", "В работе", "Ожидает решения", "Закрыта".
- Приоритеты заявок берутся из справочника "Приоритеты": "Низкий", "Средний", "Высокий", "Критический".

**Структура таблицы "Заявки (tickets)":**
| Поле                     | Тип данных | Атрибуты                              | Описание                                                     |
| :----------------------- | :--------- | :------------------------------------ | :----------------------------------------------------------- |
| ticket\_id               | integer    | PRIMARY KEY, AUTO\_INCREMENT          | Уникальный идентификатор заявки                                                       |
| device\_id               | integer    | FOREIGN KEY (ссылается на devices), NOT NULL | Внешний ключ, ID устройства, к которому относится заявка                                                       |
| user\_id                 | integer    | FOREIGN KEY (ссылается на users), NOT NULL   | Внешний ключ, ID пользователя, создавшего заявку                                                       |
| description              | text       | NOT NULL                              | Описание проблемы                                                     |
| created\_at              | timestamp  | DEFAULT CURRENT\_TIMESTAMP            | Дата и время создания заявки                                                       |
| priority\_id             | integer    | FOREIGN KEY (ссылается на priorities), NOT NULL | Внешний ключ, ID приоритета заявки                                                       |
| status\_id               | integer    | FOREIGN KEY (ссылается на statuses), NOT NULL   | Внешний ключ, ID текущего статуса заявки                                                       |
| updated\_at              | timestamp  | DEFAULT CURRENT\_TIMESTAMP            | Дата и время последнего обновления заявки                                                       |
| closed\_at               | timestamp  |                                       | Дата и время закрытия заявки (может быть NULL)                                                        |
| resolution\_notes        | text       |                                       | примечание  (может быть NULL)                                                        |

*Примечание: Связь с файлами (таблица `files`) осуществляется через поле `ticket_id` в таблице `files` (отношение один-ко-многим).* 

**Структура таблицы "Назначения техников (technician\_assignments)":**
| Поле             | Тип данных | Атрибуты                              | Описание                                                               |
| :--------------- | :--------- | :------------------------------------ | :--------------------------------------------------------------------- |
| assignment\_id   | integer    | PRIMARY KEY, AUTO\_INCREMENT          | Уникальный идентификатор назначения                                                             |
| ticket\_id       | integer    | FOREIGN KEY (ссылается на tickets), NOT NULL | Внешний ключ, ID заявки, к которой назначен техник                                                                 |
| technician\_id   | integer    | FOREIGN KEY (ссылается на users), NOT NULL   | Внешний ключ, ID техника, назначенного на заявку                                                                 |
| assigned\_at     | timestamp  | DEFAULT CURRENT\_TIMESTAMP            | Дата и время назначения техника на заявку                                                                 |

**Структура таблицы "Файлы (files)":**
| Поле          | Тип данных | Атрибуты                              | Описание                                                   |
| :------------ | :--------- | :------------------------------------ | :--------------------------------------------------------- |
| file\_id      | integer    | PRIMARY KEY, AUTO\_INCREMENT          | Уникальный идентификатор файла                               |
| ticket\_id    | integer    | FOREIGN KEY (ссылается на tickets), NOT NULL | Внешний ключ, ID заявки, к которой прикреплен файл         |
| file\_name    | varchar    | NOT NULL                              | Оригинальное имя файла                                       |
| file\_path    | text       | NOT NULL                              | Путь к файлу в хранилище                                   |
| file\_type    | varchar    | NOT NULL                              | MIME-тип файла                                             |
| file\_size    | bigint     | NOT NULL                              | Размер файла в байтах                                        |
| uploaded\_at  | timestamp  | DEFAULT CURRENT\_TIMESTAMP            | Дата и время загрузки файла                                  |

**Структура таблицы "Приоритеты (priorities)":**
| Поле             | Тип данных | Атрибуты                     | Описание                                      |
| :--------------- | :--------- | :--------------------------- | :-------------------------------------------- |
| priority\_id     | integer    | PRIMARY KEY, AUTO\_INCREMENT | Уникальный идентификатор приоритета           |
| name           | varchar    | NOT NULL, UNIQUE             | Название приоритета (например, 'Низкий', 'Средний') |
| display\_order | integer    |                              | Порядок отображения приоритетов (необязательно) |

**Структура таблицы "Статусы (statuses)":**
| Поле           | Тип данных | Атрибуты                     | Описание                                    |
| :------------- | :--------- | :--------------------------- | :------------------------------------------ |
| status\_id     | integer    | PRIMARY KEY, AUTO\_INCREMENT | Уникальный идентификатор статуса            |
| name         | varchar    | NOT NULL, UNIQUE             | Название статуса (например, 'Новая', 'В работе') |
| display\_order | integer    |                              | Порядок отображения статусов (необязательно) |
| is\_final    | boolean    | NOT NULL, DEFAULT FALSE      | Флаг завершающего статуса (закрывает заявку) |

### 3.3. Управление пользователями
- Администратор добавляет новых пользователей (имя, телефон, роль, отдел, фото/аватар).
- Администратор может изменять роль существующего пользователя (назначать обычного пользователя техником или администратором).
- Возможность фильтрации и поиска пользователей.
- Администратор может создавать новых пользователей.

**Структура таблицы "Пользователи (users)":**
| Поле                         | Тип данных | Атрибуты                                        | Описание                                                                 |
| :--------------------------- | :--------- | :---------------------------------------------- | :----------------------------------------------------------------------- |
| user\_id                     | integer    | PRIMARY KEY, AUTO\_INCREMENT                    | Уникальный идентификатор пользователя                                      |
| username                     | varchar    | NOT NULL, INDEX, UNIQUE                         | Уникальный логин пользователя для входа в систему                            |
| password\_hash               | varchar    | NOT NULL                                        | Хэшированный пароль пользователя                                           |
| email                        | varchar    | INDEX, UNIQUE                                   | Email пользователя (необязательное поле)                                    |
| first\_name                  | varchar    |                                                 | Имя пользователя (необязательное поле)                                      |
| last\_name                   | varchar    |                                                 | Фамилия пользователя (необязательное поле)                                  |
| phone\_number                | varchar    |                                                 | Номер телефона пользователя                                                |
| role_id                      | integer    | FOREIGN KEY (ссылается на user_roles), NOT NULL | Внешний ключ, ID роли пользователя из таблицы user_roles                 |
| department                   | varchar    |                                                 | Отдел, в котором работает пользователь                                     |
| avatar\_url                  | varchar    |                                                 | URL-адрес или путь к файлу с фотографией/аватаром пользователя (может быть NULL) |
| created\_at                  | timestamp  | DEFAULT CURRENT\_TIMESTAMP                      | Дата и время создания записи о пользователе                                |
| updated\_at                  | timestamp  | DEFAULT CURRENT\_TIMESTAMP                      | Дата и время последнего обновления записи о пользователе                   |

### 3.4. Справочник оборудования
- CRUD-операции (добавление, редактирование, удаление) устройств и типов устройств через админ-панель.
- Список устройств (ID, название, тип, инвентарный номер).
- Тип устройства выбирается из справочника **"Типы устройств"**.

**Структура таблицы "Типы устройств (device\_types)":**
| Поле                  | Тип данных | Атрибуты                     | Описание                                           |
| :-------------------- | :--------- | :--------------------------- | :------------------------------------------------- |
| device\_type\_id      | integer    | PRIMARY KEY, AUTO\_INCREMENT | Уникальный идентификатор типа устройства           |
| name                  | varchar    | NOT NULL, UNIQUE             | Название типа устройства (например, 'весы', 'термометр') |

**Структура таблицы "Устройства (devices)":**
| Поле               | Тип данных | Атрибуты                              | Описание                                                                     |
| :----------------- | :--------- | :------------------------------------ | :--------------------------------------------------------------------------- |
| device\_id         | integer    | PRIMARY KEY                           | Уникальный идентификатор устройства                                                                   |
| name               | varchar    | NOT NULL, INDEX                       | Название устройства                                                                   |
| device\_type\_id   | integer    | FOREIGN KEY (ссылается на device\_types\_id) | Внешний ключ, указывающий на ID типа устройства из таблицы device\_types                                                                |
| inventory\_number  | varchar    |                                       | Инвентарный номер устройства (может быть NULL)                                                                        |

### 3.5. Фильтрация и поиск заявок
- Поиск по:
    - **ID**
    - **Статусу**
    - **Дате**
    - **Пользователю**
    - **Описание проблемы**
- Фильтры по:
    - **Статусу**
    - **Технику**
    - **Оборудованию**
    - **Пользователю**
- Сортировка по дате создания, последнему изменению.

### 3.6. Экспорт отчётов
- Администратор может выгружать отчёты по заявкам в CSV.

### 3.7. Локализация
- Фронтенд:
  - Интеграция i18next с React через react-i18next и компонентом `I18nextProvider` в `Providers.tsx` для клиентского и серверного рендеринга.
  - Конфигурация в `i18n.ts`: ресурсы `ru`, `en`, `sl`; `lng: 'ru'`; `fallbackLng: 'ru'`.
  - Структура переводов: папка `/locales/{lang}/{namespace}.json` (например, `/locales/ru/common.json`, `/locales/sl/common.json`).
  - Использование хуков `useTranslation` и компонента `<Trans>` для перевода строк.
  - Селектор языка в шапке или автоматический выбор по заголовку `Accept-Language`.
  - Форматирование дат и чисел через `Intl.DateTimeFormat` с локалью, или подключение `dayjs` с плагином `localizedFormat`.
  - Бэкенд (опционально): перевод сообщений об ошибках через словарь и обработка заголовка `Accept-Language`.

## 4. Админ-панель
Будет доступен интерфейс для администратора с возможностями:
- **Управление пользователями**: список, создание, редактирование, удаление.
- **Управление устройствами**: список (`/admin/devices`), создание (`/admin/devices/new`), редактирование (`/admin/devices/edit/{device_id}`), удаление устройств.
- **Управление типами устройств**: список, CRUD.
- **Управление статусами заявок**: список (`/admin/statuses`), создание (`/admin/statuses/new`), редактирование (`/admin/statuses/edit/{status_id}`), удаление.
- **Управление приоритетами заявок**: список (`/admin/priorities`), создание (`/admin/priorities/new`), редактирование (`/admin/priorities/edit/{priority_id}`), удаление.
- **Управление ролями пользователей**: список (`/admin/roles`), создание (`/admin/roles/new`), редактирование (`/admin/roles/edit/{role_id}`), удаление.
- **Управление заявками**: список, добавление примечаний.
- **Выгрузка отчётов**: экспорт в CSV.
- **Управление статусами заявок**: список (`/admin/statuses`), создание (`/admin/statuses/new`), редактирование (`/admin/statuses/edit/{status_id}`), удаление.

## 5. Архитектура
- **Фронтенд (Next.js + PWA):**
    - SSR (Server-Side Rendering) для быстрого рендеринга.
    - Поддержка работы в оффлайн-режиме (PWA).

- **Бэкенд (FastAPI):**
    - REST API + WebSockets (для будущих уведомлений).
    - Использование Pydantic версии 2.x для валидации данных и настроек.
    - Обработка файлов и сохранение в облаке.
    - JWT-аутентификация.

- **База данных (PostgreSQL):**
      - Таблицы: пользователи, заявки, устройства, роли пользователей, типы устройств, приоритеты, статусы, файлы, назначения техников.
      - Индексы для быстрого поиска.